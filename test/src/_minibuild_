print("Here!\n")

TEST := defined("TEST")

if TEST then
	setenv("TEST_CFLAGS", "-pipe")
end

var Config := file("config") => fun(Target) do
	var File := Target:open("w")
	File:write("#!/bin/sh\n")
	File:write("echo \"-g -O1 $TEST_CFLAGS\"\n")
	File:close()
	execute("chmod +x", Target)
end

var TestCflags := expr("TestCflags")[Config, "TEST"] => fun() shell(Config):trim

CFLAGS := old + [TestCflags]

c_program(file("test"), [file("test.o"), file("test2.o")])

for File := file(""):ls(".*\\.c") do
	print('Found {File}\n')
end
